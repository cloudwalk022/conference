{% extends "aiml_app/base.html" %}
{% block content %}
<h2>Step 4: Registration & Payment</h2>
<form method="post" id="payment-form">{% csrf_token %}
    {{ wizard.management_form }}
    {{ form.as_p }}

    <div class="mb-3">
        <label>Registration Fee:</label>
        <input type="text" id="registration_fee" readonly class="form-control" title="Price will update automatically">
    </div>

    <button class="btn btn-secondary" name="wizard_goto_step" value="{{ wizard.steps.prev }}">Back</button>
    <button class="btn btn-success" type="submit">Submit</button>
</form>

<style>
    .invalid-field { border-color: red !important; }
    .valid-field { border-color: green !important; }
</style>

<script>
    const prices = {{ registration_prices|safe }};
    
    function updateFee() {
        const regType = $('#id_registration_type').val();
        const fee = prices[regType] || 0;
        $('#registration_fee').val('$' + fee.toFixed(2));
        $('#registration_fee').attr('title', 'Price for selected type: $' + fee.toFixed(2));
    }

    $('#id_registration_type').change(updateFee);
    $(document).ready(updateFee);  // Set fee on page load

    function validateField(field, isValid){
        if(isValid){
            field.removeClass('invalid-field').addClass('valid-field');
        } else {
            field.removeClass('valid-field').addClass('invalid-field');
        }
    }

    $('#payment-form').on('submit', function(e){
        let valid = true;

        const cardField = $('#id_card_number');
        const expiryField = $('#id_expiry_date');
        const cvvField = $('#id_cvv');

        const card = cardField.val();
        const expiry = expiryField.val();
        const cvv = cvvField.val();

        // Card number validation
        validateField(cardField, /^\d{13,16}$/.test(card) ? true : false);

        // Expiry validation MM/YY
        let expiryValid = false;
        if(/^(0[1-9]|1[0-2])\/\d{2}$/.test(expiry)){
            const parts = expiry.split('/');
            const month = parseInt(parts[0], 10);
            const year = parseInt('20'+parts[1], 10);
            const now = new Date();
            const expDate = new Date(year, month-1, 1);
            if(expDate >= new Date(now.getFullYear(), now.getMonth(), 1)){
                expiryValid = true;
            }
        }
        validateField(expiryField, expiryValid);

        // CVV validation
        validateField(cvvField, /^\d{3,4}$/.test(cvv) ? true : false);

        // Prevent submission if invalid
        if($('.invalid-field').length > 0){
            e.preventDefault();
            alert("Please fix the highlighted fields.");
        }
    });
</script>
{% endblock %}
